# .github/workflows/deploy.yml

name: Deploy Cloudflare Workers and KV Data

on:
  push:
    branches:
      - main
    paths:
      - 'worker.js'
      - 'wrangler.toml'
      - 'brands_data.json'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        account_config:
          - account: "AU218"
            dyn2: "20"
            dyn3: "15"

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets[format('CLOUDFLARE_API_TOKEN_{0}', matrix.account_config.account) ] }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets[format('CLOUDFLARE_ACCOUNT_ID_{0}', matrix.account_config.account) ] }}
      KV_NAMESPACE_ID: ${{ secrets[format('KV_NAMESPACE_ID_{0}', matrix.account_config.account) ] }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Perform Deployment for ${{ matrix.account_config.account }}
        run: |
          if [ -z "$KV_NAMESPACE_ID" ]; then
            echo "‚ùå KV_NAMESPACE_ID is not set for ${{ matrix.account_config.account }}"
            exit 1
          fi
          set -e
          
          export AU_PREFIX=${{ matrix.account_config.account }}
          export DYN2_VALUE=${{ matrix.account_config.dyn2 }}
          export DYN3_VALUE=${{ matrix.account_config.dyn3 }}

          echo "--- Deploying to Cloudflare account: ${{ matrix.account_config.account }} ---"
          echo "  Account ID: $CLOUDFLARE_ACCOUNT_ID"
          echo "  KV Namespace ID: $KV_NAMESPACE_ID"
          echo "  AU Prefix: $AU_PREFIX"
          echo "  DYN2 Value: $DYN2_VALUE"
          echo "  DYN3 Value: $DYN3_VALUE"

          # Update KV Data
          jq -c '.[]' brands_data.json | while read -r line; do
            ID=$(echo "$line" | jq -r '.id')
            VALUE=$(echo "$line" | jq -c '{baseUrl: .baseUrl, fullQueryStringTemplate: .fullQueryStringTemplate}')
            wrangler kv:key put "$ID" "$VALUE" --namespace-id "$KV_NAMESPACE_ID"
          done
          echo "KV data updated for ${{ matrix.account_config.account }}."

          # Deploy Worker
          NAME="$(echo '${{ matrix.account_config.account }}' | tr '[:upper:]' '[:lower:]')-brand-redirect"
          
          wrangler deploy worker.js \
            --minify \
            --name "$NAME" \
            --compatibility-date "2024-06-25" \
            --account-id "$CLOUDFLARE_ACCOUNT_ID" \
            --kv BRAND_LINKS \
            --binding BRAND_LINKS "$KV_NAMESPACE_ID" \
            --var AU_PREFIX="$AU_PREFIX" \
            --var DYN2_VALUE="$DYN2_VALUE" \
            --var DYN3_VALUE="$DYN3_VALUE"

          echo "--- Worker deployed for ${{ matrix.account_config.account }} ---"
          echo "---------------------------------------------------"