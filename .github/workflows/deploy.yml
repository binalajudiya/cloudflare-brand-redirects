name: Deploy Cloudflare Workers and KV Data

on:
  push:
    branches:
      - main
    paths:
      - 'worker.js'
      - 'wrangler.toml'
      - 'brands_data.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        account: ["AU210"]  # Add more account prefixes as needed

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets[format('CLOUDFLARE_ACCOUNT_ID_{0}', matrix.account)] }}
      KV_NAMESPACE_ID: ${{ secrets[format('KV_NAMESPACE_ID_{0}', matrix.account)] }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Perform Deployment for ${{ matrix.account }}
        run: |
          set -e

          export AU_PREFIX=${{ matrix.account }}
          echo "--- Deploying to Cloudflare account: $AU_PREFIX ---"
          echo "  Account ID: $CLOUDFLARE_ACCOUNT_ID"
          echo "  KV Namespace ID: $KV_NAMESPACE_ID"

          # Step A: Fully sync KV (delete old + upload new)

          echo "  Wiping all KV keys in namespace: $KV_NAMESPACE_ID..."

          # Get all existing keys (handles up to 10,000 via pagination if needed)
          PAGE=1
          while true; do
            KEYS=$(wrangler kv key list --namespace-id "$KV_NAMESPACE_ID" --preview=false --page $PAGE)
            COUNT=$(echo "$KEYS" | jq length)

            # Break if no more keys
            if [ "$COUNT" -eq 0 ]; then
              break
            fi

            # Delete keys on this page
            echo "$KEYS" | jq -r '.[].name' | while read -r key; do
              echo "    Deleting KV key: $key"
              wrangler kv key delete "$key" --namespace-id "$KV_NAMESPACE_ID"
            done

            PAGE=$((PAGE + 1))
          done

          echo "  KV wiped. Uploading fresh data..."

          # Upload all keys from brands_data.json
          jq -c '.[]' brands_data.json | while read -r line; do
            ID=$(echo "$line" | jq -r '.id')
            VALUE=$(echo "$line" | jq -c '{baseUrl: .baseUrl, fullQueryStringTemplate: .fullQueryStringTemplate}')
            
            echo "    Uploading KV key: $ID"
            wrangler kv key put "$ID" "$VALUE" --namespace-id "$KV_NAMESPACE_ID"
          done

          echo "  KV sync complete for ${{ matrix.account }}."


          # Step B: Deploy Worker
          NAME="$(echo '${{ matrix.account }}' | tr '[:upper:]' '[:lower:]')-brand-redirect"
          echo "  Deploying Worker: $NAME"

          wrangler deploy --minify \
            --name "$NAME" \
            --compatibility-date "2024-06-23"

          echo "--- Worker deployed for $AU_PREFIX ---"
          echo "----------------------------------------"
